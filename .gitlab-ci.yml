stages:
  - vulnerabilities
  - test

######################################
# Vulnerabilities stage related jobs #
######################################
check php vendors:
  stage: vulnerabilities
  image: sumocoders/framework-php72
  before_script:
    - touch .env
    - composer install --no-scripts
  script:
    - bin/security-checker security:check
  tags:
    - docker

check npm dependencies:
  stage: vulnerabilities
  image: node:10.6
  script:
    - npm audit --json
  tags:
    - docker


###########################
# Test stage related jobs #
###########################
run phpunit tests:
  stage: test
  image: sumocoders/fork-php71:latest
  services:
    - mysql:5.5
  before_script:
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --no-scripts --quiet --ignore-platform-reqs
    - mysql -h mysql -u root -proot -e "create database ci_test"
    - mysql -h mysql -u root -proot ci_test < tests/data/test_db.sql
    - php bin/generate-parameters-gitlab
    - cp app/config/parameters.yml.gitlab app/config/parameters.yml
  script:
    - SYMFONY_DEPRECATIONS_HELPER=weak bin/simple-phpunit
  stage: test
  tags:
    - docker
  variables:
    MYSQL_DATABASE: ci
    MYSQL_ROOT_PASSWORD: root

check php code styles:
  stage: test
  image: phpqa/phpcs
  script:
    - phpcs --standard=psr2 --extensions=php --warning-severity=0 --ignore=src/Backend/Core/Js/ckfinder,src/Backend/Cache,src/Frontend/Cache,src/Backend/Core/Js/ckeditor src/
  tags:
    - docker
